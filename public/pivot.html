<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pivot Analysis</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    body { overflow-y: auto; }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ── Cards ── */
    .card {
      background: #1e1e1e;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 16px;
    }

    .card h2 {
      font-size: 14px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    /* ── Today Summary ── */
    .today-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .stat-box {
      background: #252525;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .stat-box .stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .stat-box .stat-value {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .stat-box .stat-sub {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    /* ── Hourly Heatmap ── */
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 2px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      color: rgba(255,255,255,0.7);
      position: relative;
      cursor: default;
      min-height: 32px;
    }

    .heatmap-cell .cell-hour {
      font-size: 8px;
      color: #666;
      position: absolute;
      bottom: 1px;
    }

    .heatmap-labels {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 2px;
      margin-top: 2px;
    }

    .heatmap-labels span {
      text-align: center;
      font-size: 10px;
      color: #555;
    }

    .heatmap-row-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .heatmap-section { margin-bottom: 12px; }

    /* ── Session Zones ── */
    .session-zones {
      display: flex;
      gap: 2px;
      margin-bottom: 8px;
    }

    .session-zone {
      flex: 1;
      text-align: center;
      padding: 3px 0;
      font-size: 10px;
      font-weight: 600;
      border-radius: 3px;
    }

    /* ── Day of Week ── */
    .dow-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .dow-cell {
      background: #252525;
      border-radius: 6px;
      padding: 10px 6px;
      text-align: center;
    }

    .dow-cell .dow-name {
      font-size: 11px;
      color: #888;
      font-weight: 500;
    }

    .dow-cell .dow-bar {
      height: 40px;
      margin: 6px auto;
      width: 16px;
      border-radius: 3px;
      position: relative;
      background: #333;
    }

    .dow-cell .dow-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 3px;
      transition: height 0.3s;
    }

    .dow-cell .dow-pct {
      font-size: 12px;
      font-weight: 700;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    /* ── Distance Histogram ── */
    .histogram {
      display: flex;
      align-items: flex-end;
      gap: 1px;
      height: 100px;
      margin-top: 8px;
    }

    .hist-bar {
      flex: 1;
      border-radius: 2px 2px 0 0;
      min-width: 4px;
      position: relative;
      cursor: default;
      transition: opacity 0.15s;
    }

    .hist-bar:hover { opacity: 0.8; }

    .hist-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 10px;
      color: #555;
    }

    .hist-stats {
      display: flex;
      gap: 20px;
      margin-top: 8px;
      font-size: 12px;
    }

    .hist-stats span {
      color: #888;
    }

    .hist-stats strong {
      color: #e0e0e0;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    /* ── Insights ── */
    .insights-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .insight {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      background: #252525;
      border-radius: 6px;
      border-left: 3px solid;
    }

    .insight.green { border-color: #32D695; }
    .insight.yellow { border-color: #E6A817; }
    .insight.red { border-color: #FF4C61; }

    .insight .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .insight.green .dot { background: #32D695; }
    .insight.yellow .dot { background: #E6A817; }
    .insight.red .dot { background: #FF4C61; }

    .insight .insight-text {
      font-size: 13px;
      line-height: 1.4;
    }

    /* ── Daily Table ── */
    .pivot-table-data {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .pivot-table-data th {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #333;
      color: #666;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      background: #1e1e1e;
    }

    .pivot-table-data td {
      padding: 5px 8px;
      border-bottom: 1px solid #222;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .pivot-table-data tr:hover td { background: #252525; }

    .p1-high { color: #FF4C61; }
    .p1-low { color: #32D695; }

    .table-scroll {
      max-height: 300px;
      overflow-y: auto;
    }

    /* ── Weekday Filter ── */
    .weekday-filter {
      display: flex;
      gap: 4px;
      margin-left: 8px;
    }

    .weekday-filter button {
      font-size: 11px;
      padding: 4px 6px;
      min-width: 32px;
    }

    .weekday-filter button.active {
      background: #32D695;
      color: #161616;
      border-color: #32D695;
    }

    /* ── Two Column ── */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .two-col { grid-template-columns: 1fr; }
      .heatmap-grid { grid-template-columns: repeat(12, 1fr); }
      .heatmap-labels { grid-template-columns: repeat(12, 1fr); }
      .dow-grid { grid-template-columns: repeat(4, 1fr); }
    }

    @media (max-width: 600px) {
      .content { padding: 10px; gap: 14px; }
      .today-summary { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <span class="logo">MMT Tools</span>
    <a href="/">Session Candles</a>
    <a href="/pivot.html" class="active">Pivot Analysis</a>
  </nav>

  <div class="toolbar">
    <span class="label">Symbol</span>
    <select id="symbol-select">
      <option value="btc/usd">BTC/USD</option>
      <option value="eth/usd">ETH/USD</option>
      <option value="sol/usd">SOL/USD</option>
    </select>

    <span class="label">Exchange</span>
    <select id="exchange-select">
      <optgroup label="Futures (Linear)">
        <option value="binancef">Binance Futures</option>
        <option value="bybitf">Bybit Futures</option>
        <option value="okxf">OKX Futures</option>
        <option value="deribitf">Deribit Futures</option>
        <option value="hyperliquid">Hyperliquid</option>
        <option value="hyperliquid-xyz">Hyperliquid XYZ</option>
        <option value="bitmexf">BitMEX Futures</option>
        <option value="bitfinexf">Bitfinex Futures</option>
        <option value="lighterf">Lighter</option>
      </optgroup>
      <optgroup label="Futures (Inverse)">
        <option value="bybitf-inverse">Bybit Inverse</option>
        <option value="bitmexf-inverse">BitMEX Inverse</option>
        <option value="deribitf-inverse">Deribit Inverse</option>
      </optgroup>
      <optgroup label="Spot">
        <option value="binance">Binance Spot</option>
        <option value="bybit">Bybit Spot</option>
        <option value="coinbase">Coinbase</option>
        <option value="okx">OKX Spot</option>
        <option value="deribit">Deribit Spot</option>
        <option value="kraken">Kraken</option>
        <option value="bitfinex">Bitfinex</option>
      </optgroup>
    </select>

    <span class="label">Days</span>
    <select id="days-select">
      <option value="14">14</option>
      <option value="30">30</option>
      <option value="42" selected>42</option>
      <option value="60">60</option>
      <option value="90">90</option>
    </select>

    <span class="label">Filter</span>
    <div class="weekday-filter" id="weekday-filter">
      <button class="active" data-day="all">All</button>
      <button data-day="1">M</button>
      <button data-day="2">T</button>
      <button data-day="3">W</button>
      <button data-day="4">T</button>
      <button data-day="5">F</button>
      <button data-day="6">S</button>
      <button data-day="0">S</button>
    </div>
  </div>

  <div class="content" id="content">
    <div class="loading" id="loading" style="text-align:center;padding:40px;">Loading pivot data...</div>
  </div>

  <script>
    // ── State ──
    let allPivots = [];
    let filteredPivots = [];
    let hourlyCandles = [];
    let weekdayFilter = 'all';

    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const SESSION_COLORS = {
      Asia: { bg: 'rgba(74,144,217,0.15)', text: '#4A90D9' },
      London: { bg: 'rgba(230,168,23,0.15)', text: '#E6A817' },
      'New York': { bg: 'rgba(217,74,74,0.15)', text: '#D94A4A' },
      Close: { bg: 'rgba(139,92,246,0.15)', text: '#8B5CF6' },
    };

    function getSession(hour) {
      if (hour >= 0 && hour < 6) return 'Asia';
      if (hour >= 6 && hour < 12) return 'London';
      if (hour >= 12 && hour < 20) return 'New York';
      return 'Close';
    }

    // ── Fetch ──
    async function fetchCandles(exchange, symbol, days) {
      const now = Math.floor(Date.now() / 1000);
      const from = now - (days + 1) * 86400; // extra day for safety
      const url = `/api/candles?exchange=${exchange}&symbol=${encodeURIComponent(symbol)}&tf=1h&from=${from}&to=${now}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if (json.error) throw new Error(json.error);
      return (json.data || []).map(c => ({
        timestamp: c.t * 1000,
        open: c.o,
        high: c.h,
        low: c.l,
        close: c.c,
        hour: new Date(c.t * 1000).getUTCHours(),
      }));
    }

    // ── Calculate Daily Pivots ──
    function calculateDailyPivots(candles) {
      // Group by UTC day
      const days = {};
      for (const c of candles) {
        const d = new Date(c.timestamp);
        const key = d.toISOString().slice(0, 10);
        if (!days[key]) days[key] = [];
        days[key].push(c);
      }

      const pivots = [];
      for (const [date, dayCandles] of Object.entries(days)) {
        if (dayCandles.length < 12) continue; // skip incomplete days

        dayCandles.sort((a, b) => a.timestamp - b.timestamp);

        const dayOpen = dayCandles[0].open;
        let highVal = -Infinity, lowVal = Infinity;
        let highHour = 0, lowHour = 0;
        let highTime = 0, lowTime = 0;

        for (const c of dayCandles) {
          if (c.high > highVal) {
            highVal = c.high;
            highHour = c.hour;
            highTime = c.timestamp;
          }
          if (c.low < lowVal) {
            lowVal = c.low;
            lowHour = c.hour;
            lowTime = c.timestamp;
          }
        }

        const highFirst = highTime <= lowTime;
        const dayOfWeek = new Date(dayCandles[0].timestamp).getUTCDay();
        const dayClose = dayCandles[dayCandles.length - 1].close;

        const p1 = highFirst
          ? { price: highVal, hour: highHour, type: 'high' }
          : { price: lowVal, hour: lowHour, type: 'low' };

        const p2 = highFirst
          ? { price: lowVal, hour: lowHour, type: 'low' }
          : { price: highVal, hour: highHour, type: 'high' };

        const openToP1 = Math.abs(p1.price - dayOpen) / dayOpen * 100;
        const p1ToP2 = Math.abs(p2.price - p1.price) / p1.price * 100;
        const range = (highVal - lowVal) / lowVal * 100;

        pivots.push({
          date, dayOfWeek, dayOpen, dayClose,
          high: highVal, low: lowVal, range,
          p1, p2, openToP1, p1ToP2,
        });
      }

      return pivots.sort((a, b) => a.date.localeCompare(b.date));
    }

    // ── Hourly Stats ──
    function calculateHourlyStats(pivots) {
      const p1Counts = new Array(24).fill(0);
      const p2Counts = new Array(24).fill(0);
      const total = pivots.length || 1;

      for (const p of pivots) {
        p1Counts[p.p1.hour]++;
        p2Counts[p.p2.hour]++;
      }

      return {
        p1: p1Counts.map(c => (c / total * 100)),
        p2: p2Counts.map(c => (c / total * 100)),
        p1Raw: p1Counts,
        p2Raw: p2Counts,
      };
    }

    // ── Day of Week Stats ──
    function calculateDayStats(pivots) {
      const counts = new Array(7).fill(0);
      const highFirst = new Array(7).fill(0);
      const total = new Array(7).fill(0);

      for (const p of pivots) {
        total[p.dayOfWeek]++;
        if (p.p1.type === 'high') highFirst[p.dayOfWeek]++;
      }

      return { total, highFirst };
    }

    // ── Distance Stats ──
    function distanceStats(values) {
      if (!values.length) return { mean: 0, median: 0, min: 0, max: 0, stdev: 0 };
      const sorted = [...values].sort((a, b) => a - b);
      const mean = values.reduce((a, b) => a + b, 0) / values.length;
      const median = sorted[Math.floor(sorted.length / 2)];
      const variance = values.reduce((sum, v) => sum + (v - mean) ** 2, 0) / values.length;
      return { mean, median, min: sorted[0], max: sorted[sorted.length - 1], stdev: Math.sqrt(variance) };
    }

    function buildHistogram(values, bins = 30) {
      if (!values.length) return { bins: [], min: 0, max: 0 };
      const min = Math.min(...values);
      const max = Math.max(...values);
      const step = (max - min) / bins || 1;
      const histogram = new Array(bins).fill(0);

      for (const v of values) {
        const i = Math.min(Math.floor((v - min) / step), bins - 1);
        histogram[i]++;
      }

      return { bins: histogram, min, max, step };
    }

    // ── Insights ──
    function generateInsights(pivots, hourlyStats) {
      const insights = [];
      if (!pivots.length) return insights;

      const today = new Date();
      const todayDow = today.getUTCDay();
      const currentHour = today.getUTCHours();

      // High-first vs Low-first ratio
      const highFirstCount = pivots.filter(p => p.p1.type === 'high').length;
      const highFirstPct = (highFirstCount / pivots.length * 100).toFixed(0);
      const lowFirstPct = (100 - highFirstPct).toFixed(0);

      if (highFirstPct > 60) {
        insights.push({ color: 'red', text: `Price tends to reach the HIGH first ${highFirstPct}% of the time — watch for early fakeout longs.` });
      } else if (lowFirstPct > 60) {
        insights.push({ color: 'green', text: `Price tends to reach the LOW first ${lowFirstPct}% of the time — early dips may be buying opportunities.` });
      } else {
        insights.push({ color: 'yellow', text: `Balanced market — high-first ${highFirstPct}% vs low-first ${lowFirstPct}%. No strong directional bias in pivot formation.` });
      }

      // Peak P1 hour
      const peakP1Hour = hourlyStats.p1.indexOf(Math.max(...hourlyStats.p1));
      const peakP1Pct = hourlyStats.p1[peakP1Hour].toFixed(0);
      const peakSession = getSession(peakP1Hour);
      insights.push({
        color: 'yellow',
        text: `P1 (first pivot) forms most frequently at ${peakP1Hour}:00 UTC (${peakSession} session) — ${peakP1Pct}% of days.`
      });

      // Peak P2 hour
      const peakP2Hour = hourlyStats.p2.indexOf(Math.max(...hourlyStats.p2));
      const peakP2Pct = hourlyStats.p2[peakP2Hour].toFixed(0);
      const peakP2Session = getSession(peakP2Hour);
      insights.push({
        color: 'yellow',
        text: `P2 (second pivot) forms most frequently at ${peakP2Hour}:00 UTC (${peakP2Session} session) — ${peakP2Pct}% of days.`
      });

      // Average range
      const avgRange = pivots.reduce((s, p) => s + p.range, 0) / pivots.length;
      insights.push({
        color: avgRange > 5 ? 'red' : avgRange > 2.5 ? 'yellow' : 'green',
        text: `Average daily range: ${avgRange.toFixed(2)}%. ${avgRange > 5 ? 'High volatility environment.' : avgRange > 2.5 ? 'Moderate volatility.' : 'Low volatility — tight ranges.'}`
      });

      // Current time context
      const p1Before = hourlyStats.p1.slice(0, currentHour + 1).reduce((a, b) => a + b, 0);
      if (currentHour < 20) {
        insights.push({
          color: p1Before > 70 ? 'green' : p1Before > 40 ? 'yellow' : 'red',
          text: `By ${currentHour}:00 UTC, P1 has typically formed ${p1Before.toFixed(0)}% of the time. ${p1Before > 70 ? "Today's first extreme is likely already in." : "First pivot may still be forming."}`
        });
      }

      // Open → P1 distance
      const openToP1Stats = distanceStats(pivots.map(p => p.openToP1));
      insights.push({
        color: 'green',
        text: `Avg distance from Open to P1: ${openToP1Stats.mean.toFixed(2)}% (median: ${openToP1Stats.median.toFixed(2)}%). This is the typical first move to fade or chase.`
      });

      return insights;
    }

    // ── Render Functions ──
    function heatColor(pct, max) {
      if (max === 0) return '#252525';
      const intensity = pct / max;
      if (intensity < 0.2) return '#252525';
      if (intensity < 0.4) return 'rgba(50,214,149,0.2)';
      if (intensity < 0.6) return 'rgba(50,214,149,0.4)';
      if (intensity < 0.8) return 'rgba(50,214,149,0.6)';
      return 'rgba(50,214,149,0.85)';
    }

    function renderAll() {
      const pivots = filteredPivots;
      if (!pivots.length) {
        document.getElementById('content').innerHTML = '<div style="text-align:center;padding:40px;color:#666;">No data for selected filters.</div>';
        return;
      }

      const hourlyStats = calculateHourlyStats(pivots);
      const dayStats = calculateDayStats(pivots);
      const openToP1Vals = pivots.map(p => p.openToP1);
      const p1ToP2Vals = pivots.map(p => p.p1ToP2);
      const openToP1Stats_d = distanceStats(openToP1Vals);
      const p1ToP2Stats_d = distanceStats(p1ToP2Vals);
      const openToP1Hist = buildHistogram(openToP1Vals);
      const p1ToP2Hist = buildHistogram(p1ToP2Vals);
      const insights = generateInsights(pivots, hourlyStats);

      const today = pivots[pivots.length - 1];
      const highFirstCount = pivots.filter(p => p.p1.type === 'high').length;
      const maxP1 = Math.max(...hourlyStats.p1);
      const maxP2 = Math.max(...hourlyStats.p2);

      let html = '';

      // ── Today Summary ──
      html += `<div class="card">
        <h2>Today's Pivots — ${today.date}</h2>
        <div class="today-summary">
          <div class="stat-box">
            <div class="stat-label">P1 (${today.p1.type})</div>
            <div class="stat-value ${today.p1.type === 'high' ? 'p1-high' : 'p1-low'}">${today.p1.price.toFixed(2)}</div>
            <div class="stat-sub">${today.p1.hour}:00 UTC · ${getSession(today.p1.hour)}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">P2 (${today.p2.type})</div>
            <div class="stat-value ${today.p2.type === 'high' ? 'p1-high' : 'p1-low'}">${today.p2.price.toFixed(2)}</div>
            <div class="stat-sub">${today.p2.hour}:00 UTC · ${getSession(today.p2.hour)}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Open → P1</div>
            <div class="stat-value" style="color:#E6A817">${today.openToP1.toFixed(2)}%</div>
            <div class="stat-sub">avg: ${openToP1Stats_d.mean.toFixed(2)}%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">P1 → P2</div>
            <div class="stat-value" style="color:#E6A817">${today.p1ToP2.toFixed(2)}%</div>
            <div class="stat-sub">avg: ${p1ToP2Stats_d.mean.toFixed(2)}%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Daily Range</div>
            <div class="stat-value">${today.range.toFixed(2)}%</div>
            <div class="stat-sub">${pivots.length} days analyzed</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">High First</div>
            <div class="stat-value" style="color:#FF4C61">${(highFirstCount / pivots.length * 100).toFixed(0)}%</div>
            <div class="stat-sub">${highFirstCount}/${pivots.length} days</div>
          </div>
        </div>
      </div>`;

      // ── Hourly Heatmap ──
      html += `<div class="card">
        <h2>Pivot Hour Probability</h2>
        <div class="session-zones">
          <div class="session-zone" style="background:${SESSION_COLORS.Asia.bg};color:${SESSION_COLORS.Asia.text};flex:6">Asia (00-06)</div>
          <div class="session-zone" style="background:${SESSION_COLORS.London.bg};color:${SESSION_COLORS.London.text};flex:6">London (06-12)</div>
          <div class="session-zone" style="background:${SESSION_COLORS['New York'].bg};color:${SESSION_COLORS['New York'].text};flex:8">New York (12-20)</div>
          <div class="session-zone" style="background:${SESSION_COLORS.Close.bg};color:${SESSION_COLORS.Close.text};flex:4">Close (20-00)</div>
        </div>
        <div class="heatmap-section">
          <div class="heatmap-row-label">P1 (First Pivot)</div>
          <div class="heatmap-grid">
            ${hourlyStats.p1.map((pct, h) => `<div class="heatmap-cell" style="background:${heatColor(pct, maxP1)}" title="${h}:00 — ${pct.toFixed(1)}% (${hourlyStats.p1Raw[h]} days)">${pct >= 5 ? pct.toFixed(0) + '%' : ''}</div>`).join('')}
          </div>
          <div class="heatmap-labels">${Array.from({length:24}, (_,i) => `<span>${i}</span>`).join('')}</div>
        </div>
        <div class="heatmap-section">
          <div class="heatmap-row-label">P2 (Second Pivot)</div>
          <div class="heatmap-grid">
            ${hourlyStats.p2.map((pct, h) => `<div class="heatmap-cell" style="background:${heatColor(pct, maxP2)}" title="${h}:00 — ${pct.toFixed(1)}% (${hourlyStats.p2Raw[h]} days)">${pct >= 5 ? pct.toFixed(0) + '%' : ''}</div>`).join('')}
          </div>
          <div class="heatmap-labels">${Array.from({length:24}, (_,i) => `<span>${i}</span>`).join('')}</div>
        </div>
      </div>`;

      // ── Day of Week ──
      html += `<div class="card">
        <h2>Day of Week — High-First Probability</h2>
        <div class="dow-grid">
          ${DAYS.map((name, i) => {
            const t = dayStats.total[i];
            const hf = dayStats.highFirst[i];
            const pct = t ? (hf / t * 100) : 0;
            return `<div class="dow-cell">
              <div class="dow-name">${name}</div>
              <div class="dow-bar"><div class="dow-fill" style="height:${pct}%;background:${pct > 50 ? '#FF4C61' : '#32D695'}"></div></div>
              <div class="dow-pct" style="color:${pct > 50 ? '#FF4C61' : '#32D695'}">${pct.toFixed(0)}%</div>
              <div style="font-size:10px;color:#555;">${t} days</div>
            </div>`;
          }).join('')}
        </div>
      </div>`;

      // ── Distance Histograms ──
      html += `<div class="two-col">`;

      // Open → P1
      const maxOp1 = Math.max(...openToP1Hist.bins, 1);
      html += `<div class="card">
        <h2>Open → P1 Distance</h2>
        <div class="histogram">
          ${openToP1Hist.bins.map((count, i) => {
            const h = (count / maxOp1 * 100);
            return `<div class="hist-bar" style="height:${h}%;background:#32D695" title="${(openToP1Hist.min + i * openToP1Hist.step).toFixed(2)}% — ${count} days"></div>`;
          }).join('')}
        </div>
        <div class="hist-labels"><span>${openToP1Hist.min.toFixed(2)}%</span><span>${openToP1Hist.max.toFixed(2)}%</span></div>
        <div class="hist-stats">
          <span>Mean: <strong>${openToP1Stats_d.mean.toFixed(2)}%</strong></span>
          <span>Median: <strong>${openToP1Stats_d.median.toFixed(2)}%</strong></span>
          <span>σ: <strong>${openToP1Stats_d.stdev.toFixed(2)}%</strong></span>
        </div>
      </div>`;

      // P1 → P2
      const maxP1p2 = Math.max(...p1ToP2Hist.bins, 1);
      html += `<div class="card">
        <h2>P1 → P2 Distance</h2>
        <div class="histogram">
          ${p1ToP2Hist.bins.map((count, i) => {
            const h = (count / maxP1p2 * 100);
            return `<div class="hist-bar" style="height:${h}%;background:#E6A817" title="${(p1ToP2Hist.min + i * p1ToP2Hist.step).toFixed(2)}% — ${count} days"></div>`;
          }).join('')}
        </div>
        <div class="hist-labels"><span>${p1ToP2Hist.min.toFixed(2)}%</span><span>${p1ToP2Hist.max.toFixed(2)}%</span></div>
        <div class="hist-stats">
          <span>Mean: <strong>${p1ToP2Stats_d.mean.toFixed(2)}%</strong></span>
          <span>Median: <strong>${p1ToP2Stats_d.median.toFixed(2)}%</strong></span>
          <span>σ: <strong>${p1ToP2Stats_d.stdev.toFixed(2)}%</strong></span>
        </div>
      </div>`;

      html += `</div>`;

      // ── Insights ──
      html += `<div class="card">
        <h2>Insights</h2>
        <div class="insights-list">
          ${insights.map(i => `<div class="insight ${i.color}"><span class="dot"></span><span class="insight-text">${i.text}</span></div>`).join('')}
        </div>
      </div>`;

      // ── Daily Pivot Table ──
      html += `<div class="card">
        <h2>Daily Pivot Log (${pivots.length} days)</h2>
        <div class="table-scroll">
          <table class="pivot-table-data">
            <thead><tr>
              <th>Date</th><th>Day</th><th>Open</th>
              <th>P1</th><th>P1 Hour</th><th>P1 Type</th>
              <th>P2</th><th>P2 Hour</th>
              <th>Open→P1</th><th>P1→P2</th><th>Range</th>
            </tr></thead>
            <tbody>
              ${[...pivots].reverse().map(p => `<tr>
                <td style="color:#aaa">${p.date}</td>
                <td style="color:#666">${DAYS[p.dayOfWeek]}</td>
                <td>${p.dayOpen.toFixed(2)}</td>
                <td class="${p.p1.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p1.price.toFixed(2)}</td>
                <td>${p.p1.hour}:00</td>
                <td class="${p.p1.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p1.type.toUpperCase()}</td>
                <td class="${p.p2.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p2.price.toFixed(2)}</td>
                <td>${p.p2.hour}:00</td>
                <td style="color:#E6A817">${p.openToP1.toFixed(2)}%</td>
                <td style="color:#E6A817">${p.p1ToP2.toFixed(2)}%</td>
                <td>${p.range.toFixed(2)}%</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`;

      document.getElementById('content').innerHTML = html;
    }

    // ── Load ──
    async function loadData() {
      const content = document.getElementById('content');
      content.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">Loading pivot data...</div>';

      const exchange = document.getElementById('exchange-select').value;
      const symbol = document.getElementById('symbol-select').value;
      const days = parseInt(document.getElementById('days-select').value);

      try {
        hourlyCandles = await fetchCandles(exchange, symbol, days);
        allPivots = calculateDailyPivots(hourlyCandles);
        applyFilter();
      } catch (err) {
        content.innerHTML = `<div style="text-align:center;padding:40px;color:#FF4C61;">Error: ${err.message}</div>`;
        console.error(err);
      }
    }

    function applyFilter() {
      if (weekdayFilter === 'all') {
        filteredPivots = allPivots;
      } else {
        const day = parseInt(weekdayFilter);
        filteredPivots = allPivots.filter(p => p.dayOfWeek === day);
      }
      renderAll();
    }

    // ── Events ──
    document.getElementById('symbol-select').addEventListener('change', loadData);
    document.getElementById('exchange-select').addEventListener('change', loadData);
    document.getElementById('days-select').addEventListener('change', loadData);

    document.getElementById('weekday-filter').addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      document.querySelectorAll('#weekday-filter button').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      weekdayFilter = e.target.dataset.day;
      applyFilter();
    });

    // ── Init ──
    loadData();
  </script>
</body>
</html>
