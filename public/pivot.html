<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pivot Analysis</title>
  <link rel="stylesheet" href="/shared.css">
  <style>
    body { overflow-y: auto; }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ── Tabs ── */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #2a2a2a;
      flex-shrink: 0;
    }
    .tabs button {
      background: none;
      border: none;
      color: #666;
      font-size: 13px;
      font-weight: 500;
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
    }
    .tabs button:hover { color: #aaa; }
    .tabs button.active { color: #e0e0e0; border-bottom-color: #32D695; }

    .sub-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 12px;
    }
    .sub-tabs button {
      background: #252525;
      border: 1px solid #333;
      color: #888;
      font-size: 12px;
      padding: 6px 16px;
      cursor: pointer;
      border-radius: 0;
      transition: all 0.15s;
    }
    .sub-tabs button:first-child { border-radius: 4px 0 0 4px; }
    .sub-tabs button:last-child { border-radius: 0 4px 4px 0; }
    .sub-tabs button.active { background: #32D695; color: #161616; border-color: #32D695; font-weight: 600; }

    /* ── Cards ── */
    .card {
      background: #1e1e1e;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 16px;
    }
    .card h2 {
      font-size: 14px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    /* ── Layout ── */
    .split-60-40 { display: grid; grid-template-columns: 60% 40%; gap: 16px; }
    .split-65-35 { display: grid; grid-template-columns: 65% 35%; gap: 16px; }

    @media (max-width: 900px) {
      .split-60-40, .split-65-35 { grid-template-columns: 1fr; }
    }

    /* ── Probability Table ── */
    .prob-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .prob-table th {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #333;
      color: #666;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      background: #1e1e1e;
      z-index: 2;
    }
    .prob-table td {
      padding: 8px 10px;
      border-bottom: none;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 13px;
    }
    .prob-table tr.current-hour {
      outline: 2px solid #32D695;
      outline-offset: -1px;
    }

    .prob-table td.heatmap-cell {
      text-align: right;
      font-weight: 500;
      padding: 8px 12px;
    }

    .prob-table td.last-col {
      text-align: right;
      color: #666;
      font-size: 11px;
      padding-right: 12px;
    }

    .prob-table td.hour-col {
      color: #ccc;
      padding-left: 12px;
    }

    .prob-table .check {
      color: #fff;
      font-size: 11px;
      margin-right: 4px;
    }

    .session-asia td.hour-col { border-left: 3px solid #4A90D9; }
    .session-london td.hour-col { border-left: 3px solid #E6A817; }
    .session-ny td.hour-col { border-left: 3px solid #D94A4A; }
    .session-close td.hour-col { border-left: 3px solid #8B5CF6; }

    .last-cell { cursor: pointer; color: #4A90D9; text-decoration: underline; text-decoration-style: dotted; }
    .last-cell:hover { color: #6AB0F9; }

    /* ── Popover ── */
    .popover {
      position: fixed;
      background: #252525;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 10px;
      z-index: 100;
      min-width: 180px;
      max-width: 260px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      font-size: 12px;
    }
    .popover h4 { color: #aaa; margin-bottom: 6px; font-size: 11px; text-transform: uppercase; }
    .popover ul { list-style: none; }
    .popover li { padding: 2px 0; color: #ccc; font-family: 'SF Mono','Fira Code',monospace; }

    /* ── Insights Panel ── */
    .insight-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #252525;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 12px;
      cursor: pointer;
      border-left: 3px solid #333;
      transition: background 0.15s;
    }
    .insight-row:hover { background: #2a2a2a; }
    .insight-row .insight-label { color: #aaa; }
    .insight-row .insight-val { font-family: 'SF Mono','Fira Code',monospace; font-weight: 600; }

    .indicator {
      display: inline-block;
      width: 10px; height: 10px;
      border-radius: 50%;
      margin-left: 6px;
      vertical-align: middle;
    }
    .ind-green { background: #32D695; }
    .ind-yellow { background: #E6A817; }
    .ind-red { background: #FF4C61; }

    .insight-section { margin-bottom: 14px; }
    .insight-section h3 { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }

    /* ── Histograms ── */
    .histogram-container { margin-bottom: 16px; }
    .histogram-title { font-size: 13px; color: #aaa; margin-bottom: 8px; font-weight: 500; }
    .histogram {
      display: flex;
      align-items: flex-end;
      gap: 1px;
      height: 120px;
    }
    .hist-bar {
      flex: 1;
      border-radius: 2px 2px 0 0;
      min-width: 3px;
      cursor: pointer;
      transition: opacity 0.15s, filter 0.15s;
      position: relative;
    }
    .hist-bar:hover { opacity: 0.8; }
    .hist-bar.highlighted { filter: brightness(1.5); outline: 1px solid #fff; }
    .hist-bar.dimmed { opacity: 0.3; }

    .hist-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 10px;
      color: #555;
    }
    .hist-stats {
      display: flex;
      gap: 16px;
      margin-top: 6px;
      font-size: 12px;
      flex-wrap: wrap;
    }
    .hist-stats span { color: #888; }
    .hist-stats strong { color: #e0e0e0; font-family: 'SF Mono','Fira Code',monospace; }

    .hist-zero-line {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      border-top: 1px dashed #555;
      pointer-events: none;
    }
    .histogram-wrapper { position: relative; }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #1e1e1e;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal h3 { color: #aaa; margin-bottom: 12px; font-size: 14px; }
    .modal table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .modal th { text-align: left; padding: 5px 6px; border-bottom: 1px solid #333; color: #666; font-size: 11px; text-transform: uppercase; }
    .modal td { padding: 4px 6px; border-bottom: 1px solid #222; font-family: 'SF Mono','Fira Code',monospace; }
    .modal-close {
      float: right;
      background: none;
      border: none;
      color: #888;
      font-size: 20px;
      cursor: pointer;
      padding: 0 4px;
    }
    .modal-close:hover { color: #e0e0e0; }

    .p1-high { color: #FF4C61; }
    .p1-low { color: #32D695; }

    /* ── Color scheme selector ── */
    .scheme-select { margin-left: auto; }

    /* ── Summary tab ── */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .stat-box {
      background: #252525;
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }
    .stat-box .stat-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.3px; }
    .stat-box .stat-value { font-size: 20px; font-weight: 700; margin-top: 4px; font-family: 'SF Mono','Fira Code',monospace; }
    .stat-box .stat-sub { font-size: 11px; color: #666; margin-top: 2px; }

    .table-scroll { max-height: 350px; overflow-y: auto; }

    /* ── Weekday Filter ── */
    .weekday-filter { display: flex; gap: 4px; margin-left: 8px; }
    .weekday-filter button { font-size: 11px; padding: 4px 6px; min-width: 32px; }
    .weekday-filter button.active { background: #32D695; color: #161616; border-color: #32D695; }

    /* ── Footer ── */
    .footer-bar {
      height: 30px;
      background: #1a1a1a;
      border-top: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      padding: 0 12px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      color: #666;
      flex-shrink: 0;
    }
    .footer-bar strong { color: #e0e0e0; }

    /* ── Today Chart ── */
    #today-chart {
      width: 100%;
      height: 180px;
      margin-top: 12px;
    }

    /* ── Insights monospace ── */
    .insights-mono {
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #aaa;
    }
    .insights-mono strong { color: #e0e0e0; font-weight: 700; }
    .insights-mono .section-title { color: #e0e0e0; font-weight: 700; font-size: 13px; margin-top: 14px; display: block; }
    .insights-mono .indent { padding-left: 16px; }
    .insights-mono .moderate { color: #E6A817; font-weight: 700; }
    .insights-mono .unlikely { color: #32D695; font-weight: 700; }
    .insights-mono .likely { color: #FF4C61; font-weight: 700; }

    @media (max-width: 600px) {
      .content { padding: 10px; gap: 10px; }
      .tabs button { padding: 8px 12px; font-size: 12px; }
    }
  </style>
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <nav class="nav">
    <span class="logo">MMT Tools</span>
    <a href="/">Session Candles</a>
    <a href="/pivot.html" class="active">Pivot Analysis</a>
  </nav>

  <div class="toolbar">
    <span class="label">Symbol</span>
    <select id="symbol-select">
      <option value="btc/usd">BTC/USD</option>
      <option value="eth/usd">ETH/USD</option>
      <option value="sol/usd">SOL/USD</option>
    </select>

    <span class="label">Exchange</span>
    <select id="exchange-select">
      <optgroup label="Futures (Linear)">
        <option value="binancef">Binance Futures</option>
        <option value="bybitf">Bybit Futures</option>
        <option value="okxf">OKX Futures</option>
        <option value="deribitf">Deribit Futures</option>
        <option value="hyperliquid">Hyperliquid</option>
        <option value="hyperliquid-xyz">Hyperliquid XYZ</option>
        <option value="bitmexf">BitMEX Futures</option>
        <option value="bitfinexf">Bitfinex Futures</option>
        <option value="lighterf">Lighter</option>
      </optgroup>
      <optgroup label="Futures (Inverse)">
        <option value="bybitf-inverse">Bybit Inverse</option>
        <option value="bitmexf-inverse">BitMEX Inverse</option>
        <option value="deribitf-inverse">Deribit Inverse</option>
      </optgroup>
      <optgroup label="Spot">
        <option value="binance">Binance Spot</option>
        <option value="bybit">Bybit Spot</option>
        <option value="coinbase">Coinbase</option>
        <option value="okx">OKX Spot</option>
        <option value="deribit">Deribit Spot</option>
        <option value="kraken">Kraken</option>
        <option value="bitfinex">Bitfinex</option>
      </optgroup>
    </select>

    <span class="label">Days</span>
    <select id="days-select">
      <option value="14">14</option>
      <option value="30">30</option>
      <option value="42" selected>42</option>
      <option value="60">60</option>
      <option value="90">90</option>
    </select>

    <span class="label">Filter</span>
    <div class="weekday-filter" id="weekday-filter">
      <button class="active" data-day="all">All</button>
      <button data-day="1">M</button>
      <button data-day="2">T</button>
      <button data-day="3">W</button>
      <button data-day="4">T</button>
      <button data-day="5">F</button>
      <button data-day="6">S</button>
      <button data-day="0">S</button>
    </div>

    <span class="label scheme-select">Colors</span>
    <select id="scheme-select">
      <option value="green">Green</option>
      <option value="viridis" selected>Viridis</option>
      <option value="plasma">Plasma</option>
      <option value="inferno">Inferno</option>
      <option value="turbo">Turbo</option>
      <option value="blues">Blues</option>
    </select>
  </div>

  <div class="tabs" id="main-tabs">
    <button class="active" data-tab="time">Time</button>
    <button data-tab="distance">Distance</button>
    <button data-tab="summary">Summary</button>
  </div>

  <div class="content" id="content">
    <div style="text-align:center;padding:40px;color:#666;">Loading pivot data...</div>
  </div>

  <div class="footer-bar" id="footer-bar">Days: <strong id="footer-days">—</strong> &nbsp;&nbsp; Scheme: <strong id="footer-scheme">Viridis</strong></div>

  <script>
    // ── State ──
    let allPivots = [];
    let filteredPivots = [];
    let weeklyPivots = [];
    let hourlyCandles = [];
    let weekdayFilter = 'all';
    let activeTab = 'time';
    let activeSubTab = 'daily';
    let colorScheme = 'viridis';
    let activePopover = null;
    let highlightedInsight = null;

    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const DAY_NAMES_FULL = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

    function getSession(hour) {
      if (hour >= 0 && hour < 6) return 'Asia';
      if (hour >= 6 && hour < 12) return 'London';
      if (hour >= 12 && hour < 20) return 'New York';
      return 'Close';
    }

    function getSessionClass(hour) {
      if (hour >= 0 && hour < 6) return 'session-asia';
      if (hour >= 6 && hour < 12) return 'session-london';
      if (hour >= 12 && hour < 20) return 'session-ny';
      return 'session-close';
    }

    function getDaySession(dow) {
      // For weekly view, no session zones — return empty
      return '';
    }

    // ── Color Schemes ──
    const COLOR_PALETTES = {
      green: [[37,37,37],[50,214,149]],
      viridis: [[68,1,84],[72,40,120],[62,74,137],[49,104,142],[38,130,142],[31,158,137],[53,183,121],[109,205,89],[180,222,44],[253,231,37]],
      plasma: [[13,8,135],[75,3,161],[126,3,168],[168,34,150],[203,70,121],[229,107,93],[248,148,65],[253,195,40],[240,249,33]],
      inferno: [[0,0,4],[22,11,57],[66,10,104],[106,23,110],[147,38,103],[188,55,84],[221,81,58],[243,118,27],[252,165,10],[246,215,70],[252,255,164]],
      turbo: [[48,18,59],[67,85,168],[56,151,211],[39,203,186],[47,237,131],[122,252,56],[210,237,20],[253,195,12],[248,137,7],[220,68,8],[122,4,3]],
      blues: [[37,37,37],[30,60,114],[0,100,180],[0,150,220],[80,200,255]],
    };

    function interpolatePalette(palette, t) {
      t = Math.max(0, Math.min(1, t));
      if (t === 0) return palette[0];
      if (t === 1) return palette[palette.length - 1];
      const idx = t * (palette.length - 1);
      const lo = Math.floor(idx);
      const hi = Math.min(lo + 1, palette.length - 1);
      const f = idx - lo;
      return [
        Math.round(palette[lo][0] + (palette[hi][0] - palette[lo][0]) * f),
        Math.round(palette[lo][1] + (palette[hi][1] - palette[lo][1]) * f),
        Math.round(palette[lo][2] + (palette[hi][2] - palette[lo][2]) * f),
      ];
    }

    function schemeColor(pct, max) {
      if (max === 0) return '#252525';
      const t = pct / max;
      if (t < 0.05) return '#252525';
      const pal = COLOR_PALETTES[colorScheme] || COLOR_PALETTES.green;
      const [r, g, b] = interpolatePalette(pal, t);
      return `rgb(${r},${g},${b})`;
    }

    // ── Fetch ──
    async function fetchCandles(exchange, symbol, days) {
      const now = Math.floor(Date.now() / 1000);
      const from = now - (days + 1) * 86400;
      const url = `/api/candles?exchange=${exchange}&symbol=${encodeURIComponent(symbol)}&tf=1h&from=${from}&to=${now}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if (json.error) throw new Error(json.error.message || JSON.stringify(json.error));
      return (json.data || []).map(c => ({
        timestamp: c.t * 1000,
        open: c.o,
        high: c.h,
        low: c.l,
        close: c.c,
        hour: new Date(c.t * 1000).getUTCHours(),
      }));
    }

    // ── Calculate Daily Pivots ──
    function calculateDailyPivots(candles) {
      const days = {};
      for (const c of candles) {
        const key = new Date(c.timestamp).toISOString().slice(0, 10);
        if (!days[key]) days[key] = [];
        days[key].push(c);
      }

      const pivots = [];
      for (const [date, dayCandles] of Object.entries(days)) {
        if (dayCandles.length < 12) continue;
        dayCandles.sort((a, b) => a.timestamp - b.timestamp);

        const dayOpen = dayCandles[0].open;
        const dayClose = dayCandles[dayCandles.length - 1].close;
        const dayOfWeek = new Date(dayCandles[0].timestamp).getUTCDay();

        let dailyHigh = -Infinity, dailyLow = Infinity;
        for (const c of dayCandles) {
          if (c.high > dailyHigh) dailyHigh = c.high;
          if (c.low < dailyLow) dailyLow = c.low;
        }

        let firstHighHour = -1, firstLowHour = -1;
        let firstHighTimestamp = Infinity, firstLowTimestamp = Infinity;

        for (const c of dayCandles) {
          if (firstHighHour === -1 && c.high >= dailyHigh) {
            firstHighHour = c.hour;
            firstHighTimestamp = c.timestamp;
          }
          if (firstLowHour === -1 && c.low <= dailyLow) {
            firstLowHour = c.hour;
            firstLowTimestamp = c.timestamp;
          }
          if (firstHighHour !== -1 && firstLowHour !== -1) break;
        }

        let highCameFirst;
        if (firstHighTimestamp === firstLowTimestamp) {
          const candle = dayCandles.find(c => c.timestamp === firstHighTimestamp);
          const isBullish = candle && candle.close >= candle.open;
          highCameFirst = !isBullish;
        } else {
          highCameFirst = firstHighTimestamp < firstLowTimestamp;
        }

        const p1 = highCameFirst
          ? { price: dailyHigh, hour: firstHighHour, type: 'high' }
          : { price: dailyLow, hour: firstLowHour, type: 'low' };

        const p2 = highCameFirst
          ? { price: dailyLow, hour: firstLowHour, type: 'low' }
          : { price: dailyHigh, hour: firstHighHour, type: 'high' };

        const openToP1Signed = (p1.price - dayOpen) / dayOpen * 100;
        const openToP1 = Math.abs(openToP1Signed);
        const p1ToP2Signed = (p2.price - p1.price) / p1.price * 100;
        const p1ToP2 = Math.abs(p1ToP2Signed);
        const range = (dailyHigh - dailyLow) / dailyLow * 100;

        pivots.push({
          date, dayOfWeek, dayOpen, dayClose,
          high: dailyHigh, low: dailyLow,
          highHour: firstHighHour, lowHour: firstLowHour,
          range, p1, p2, openToP1, p1ToP2,
          openToP1Signed, p1ToP2Signed,
        });
      }

      return pivots.sort((a, b) => a.date.localeCompare(b.date));
    }

    // ── Calculate Weekly Pivots ──
    function calculateWeeklyPivots(dailyPivots) {
      // Group by ISO week (Mon-Sun)
      const weeks = {};
      for (const dp of dailyPivots) {
        const d = new Date(dp.date + 'T00:00:00Z');
        // Get Monday of this week
        const day = d.getUTCDay();
        const diff = (day === 0 ? -6 : 1) - day;
        const monday = new Date(d);
        monday.setUTCDate(monday.getUTCDate() + diff);
        const weekKey = monday.toISOString().slice(0, 10);
        if (!weeks[weekKey]) weeks[weekKey] = [];
        weeks[weekKey].push(dp);
      }

      const result = [];
      for (const [weekStart, days] of Object.entries(weeks)) {
        if (days.length < 3) continue; // skip incomplete weeks

        let weeklyHigh = -Infinity, weeklyLow = Infinity;
        for (const d of days) {
          if (d.high > weeklyHigh) weeklyHigh = d.high;
          if (d.low < weeklyLow) weeklyLow = d.low;
        }

        // Find which day first reached each extreme
        let firstHighDay = null, firstLowDay = null;
        for (const d of days) {
          if (!firstHighDay && d.high >= weeklyHigh) firstHighDay = d;
          if (!firstLowDay && d.low <= weeklyLow) firstLowDay = d;
          if (firstHighDay && firstLowDay) break;
        }

        let highCameFirst;
        if (firstHighDay.date === firstLowDay.date) {
          // Same day — use the daily pivot logic (which came first within that day)
          highCameFirst = firstHighDay.highHour <= firstHighDay.lowHour;
          if (firstHighDay.highHour === firstHighDay.lowHour) {
            highCameFirst = firstHighDay.p1.type === 'high';
          }
        } else {
          highCameFirst = firstHighDay.date < firstLowDay.date;
        }

        const weekOpen = days[0].dayOpen;
        const p1 = highCameFirst
          ? { price: weeklyHigh, day: firstHighDay.dayOfWeek, date: firstHighDay.date, type: 'high' }
          : { price: weeklyLow, day: firstLowDay.dayOfWeek, date: firstLowDay.date, type: 'low' };
        const p2 = highCameFirst
          ? { price: weeklyLow, day: firstLowDay.dayOfWeek, date: firstLowDay.date, type: 'low' }
          : { price: weeklyHigh, day: firstHighDay.dayOfWeek, date: firstHighDay.date, type: 'high' };

        const openToP1 = Math.abs(p1.price - weekOpen) / weekOpen * 100;
        const p1ToP2Val = Math.abs(p2.price - p1.price) / p1.price * 100;

        result.push({
          weekStart, days: days.length,
          high: weeklyHigh, low: weeklyLow, weekOpen,
          p1, p2, openToP1, p1ToP2: p1ToP2Val,
          range: (weeklyHigh - weeklyLow) / weeklyLow * 100,
        });
      }

      return result.sort((a, b) => a.weekStart.localeCompare(b.weekStart));
    }

    // ── Enhanced Hourly Stats ──
    function calculateHourlyStats(pivots) {
      const p1Counts = new Array(24).fill(0);
      const p2Counts = new Array(24).fill(0);
      const total = pivots.length || 1;

      // Track last occurrence dates
      const p1LastDates = Array.from({length: 24}, () => []);
      const p2LastDates = Array.from({length: 24}, () => []);

      for (const p of pivots) {
        p1Counts[p.p1.hour]++;
        p2Counts[p.p2.hour]++;
        p1LastDates[p.p1.hour].push(p.date);
        p2LastDates[p.p2.hour].push(p.date);
      }

      const todayStr = new Date().toISOString().slice(0, 10);
      const todayMs = new Date(todayStr).getTime();

      const lastP1DaysAgo = p1LastDates.map(dates => {
        if (!dates.length) return null;
        const last = dates[dates.length - 1];
        return Math.round((todayMs - new Date(last).getTime()) / 86400000);
      });
      const lastP2DaysAgo = p2LastDates.map(dates => {
        if (!dates.length) return null;
        const last = dates[dates.length - 1];
        return Math.round((todayMs - new Date(last).getTime()) / 86400000);
      });

      return {
        p1: p1Counts.map(c => c / total * 100),
        p2: p2Counts.map(c => c / total * 100),
        p1Raw: p1Counts,
        p2Raw: p2Counts,
        lastP1DaysAgo,
        lastP2DaysAgo,
        p1LastDates,
        p2LastDates,
      };
    }

    // ── Day of Week Stats (for weekly pivots) ──
    function calculateWeeklyDayStats(wPivots) {
      const p1Counts = new Array(7).fill(0);
      const p2Counts = new Array(7).fill(0);
      const total = wPivots.length || 1;
      const p1LastDates = Array.from({length: 7}, () => []);
      const p2LastDates = Array.from({length: 7}, () => []);

      for (const w of wPivots) {
        p1Counts[w.p1.day]++;
        p2Counts[w.p2.day]++;
        p1LastDates[w.p1.day].push(w.p1.date);
        p2LastDates[w.p2.day].push(w.p2.date);
      }

      const todayStr = new Date().toISOString().slice(0, 10);
      const todayMs = new Date(todayStr).getTime();

      return {
        p1: p1Counts.map(c => c / total * 100),
        p2: p2Counts.map(c => c / total * 100),
        p1Raw: p1Counts,
        p2Raw: p2Counts,
        lastP1DaysAgo: p1LastDates.map(dates => {
          if (!dates.length) return null;
          return Math.round((todayMs - new Date(dates[dates.length - 1]).getTime()) / 86400000);
        }),
        lastP2DaysAgo: p2LastDates.map(dates => {
          if (!dates.length) return null;
          return Math.round((todayMs - new Date(dates[dates.length - 1]).getTime()) / 86400000);
        }),
        p1LastDates,
        p2LastDates,
      };
    }

    // ── Distance Stats ──
    function distanceStats(values) {
      if (!values.length) return { mean: 0, median: 0, min: 0, max: 0, stdev: 0 };
      const sorted = [...values].sort((a, b) => a - b);
      const mean = values.reduce((a, b) => a + b, 0) / values.length;
      const median = sorted[Math.floor(sorted.length / 2)];
      const variance = values.reduce((sum, v) => sum + (v - mean) ** 2, 0) / values.length;
      return { mean, median, min: sorted[0], max: sorted[sorted.length - 1], stdev: Math.sqrt(variance) };
    }

    function buildHistogram(values, bins = 34) {
      if (!values.length) return { bins: [], min: 0, max: 0, step: 0, indices: [] };
      const min = Math.min(...values);
      const max = Math.max(...values);
      const step = (max - min) / bins || 1;
      const histogram = new Array(bins).fill(0);
      const indices = Array.from({length: bins}, () => []);

      for (let vi = 0; vi < values.length; vi++) {
        const v = values[vi];
        const i = Math.min(Math.floor((v - min) / step), bins - 1);
        histogram[i]++;
        indices[i].push(vi);
      }

      return { bins: histogram, min, max, step, indices };
    }

    // ── Popover ──
    function showPopover(e, dates, label) {
      closePopover();
      const pop = document.createElement('div');
      pop.className = 'popover';
      const last10 = dates.slice(-10).reverse();
      pop.innerHTML = `<h4>Last ${last10.length} — ${label}</h4><ul>${last10.map(d => `<li>${d}</li>`).join('')}</ul>`;

      document.body.appendChild(pop);
      const rect = e.target.getBoundingClientRect();
      let left = rect.right + 8;
      let top = rect.top;
      if (left + 200 > window.innerWidth) left = rect.left - 200;
      if (top + 200 > window.innerHeight) top = window.innerHeight - 210;
      pop.style.left = left + 'px';
      pop.style.top = top + 'px';
      activePopover = pop;
    }

    function closePopover() {
      if (activePopover) { activePopover.remove(); activePopover = null; }
    }

    document.addEventListener('click', (e) => {
      if (activePopover && !activePopover.contains(e.target) && !e.target.classList.contains('last-cell')) {
        closePopover();
      }
    });

    // ── Modal ──
    function showModal(title, pivots) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });

      const rows = pivots.map(p => `<tr>
        <td style="color:#aaa">${p.date}</td>
        <td style="color:#666">${DAYS[p.dayOfWeek]}</td>
        <td>${p.dayOpen.toFixed(2)}</td>
        <td class="${p.p1.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p1.type.toUpperCase()} ${p.p1.hour}:00</td>
        <td class="${p.p2.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p2.type.toUpperCase()} ${p.p2.hour}:00</td>
        <td>${p.openToP1.toFixed(2)}%</td>
        <td>${p.p1ToP2.toFixed(2)}%</td>
      </tr>`).join('');

      overlay.innerHTML = `<div class="modal">
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
        <h3>${title} (${pivots.length} days)</h3>
        <table><thead><tr><th>Date</th><th>Day</th><th>Open</th><th>P1</th><th>P2</th><th>O→P1</th><th>P1→P2</th></tr></thead>
        <tbody>${rows}</tbody></table>
      </div>`;

      document.body.appendChild(overlay);
    }

    // ── Generate Insights ──
    function generateInsights(pivots) {
      if (!pivots.length) return {};

      const today = pivots[pivots.length - 1];
      const currentHour = new Date().getUTCHours();
      const hourlyStats = calculateHourlyStats(pivots);

      const highFirstCount = pivots.filter(p => p.p1.type === 'high').length;
      const highFirstPct = highFirstCount / pivots.length * 100;

      // Flip risk: how many days had P1 exceeded by later price action
      // (days where P1 direction was same as today but price went further)
      let flipRiskPct = 0;
      if (today) {
        const todayP1Level = today.p1.price;
        const todayP1Type = today.p1.type;
        const similar = pivots.slice(0, -1).filter(p => p.p1.type === todayP1Type);
        if (similar.length) {
          const exceeded = similar.filter(p => {
            if (todayP1Type === 'high') return p.low < todayP1Level && p.p2.price < todayP1Level;
            return p.high > todayP1Level && p.p2.price > todayP1Level;
          });
          // Simplified: what % of days with same P1 type had more displacement after P1 hour
          const afterP1 = pivots.slice(0, -1).filter(p => {
            if (todayP1Type === 'high') return p.high > todayP1Level;
            return p.low < todayP1Level;
          });
          flipRiskPct = afterP1.length / pivots.length * 100;
        }
      }

      // P2 completion: % of days with more displacement than current P1→P2
      const todayP1ToP2 = today ? today.p1ToP2 : 0;
      const moreDisplacement = pivots.slice(0, -1).filter(p => p.p1ToP2 > todayP1ToP2).length;
      const p2CompletionPct = pivots.length > 1 ? moreDisplacement / (pivots.length - 1) * 100 : 0;

      // P1 formed by now
      const p1BeforeNow = hourlyStats.p1.slice(0, currentHour + 1).reduce((a, b) => a + b, 0);

      // Average distances
      const openToP1Stats = distanceStats(pivots.map(p => p.openToP1));
      const p1ToP2Stats = distanceStats(pivots.map(p => p.p1ToP2));
      const avgRange = pivots.reduce((s, p) => s + p.range, 0) / pivots.length;

      return {
        today, highFirstPct, flipRiskPct, p2CompletionPct,
        p1BeforeNow, openToP1Stats, p1ToP2Stats, avgRange,
        currentHour, totalDays: pivots.length,
      };
    }

    // ── Text color contrast ──
    function textColor(bg) {
      if (!bg || bg === '#252525') return '#ffffff';
      const m = bg.match(/rgb\((\d+),(\d+),(\d+)\)/);
      if (!m) return '#ffffff';
      const lum = (0.299 * +m[1] + 0.587 * +m[2] + 0.114 * +m[3]) / 255;
      return lum > 0.5 ? '#000000' : '#ffffff';
    }

    // ── Render: TIME > Daily ──
    function renderTimeDaily() {
      const pivots = filteredPivots;
      if (!pivots.length) return noData();

      const hourlyStats = calculateHourlyStats(pivots);
      const insights = generateInsights(pivots);
      const maxP1 = Math.max(...hourlyStats.p1);
      const maxP2 = Math.max(...hourlyStats.p2);
      const currentHour = new Date().getUTCHours();

      // Today's pivot hours for checkmarks
      const today = insights.today;
      const todayP1Hour = today ? today.p1.hour : -1;
      const todayP2Hour = today ? today.p2.hour : -1;

      // P1 status metrics
      let p1FormedAfterPct = 0, p1FormedAtOrAfterP2Pct = 0;
      let p2FormedAfterPct = 0, p2FormedAfterP2Pct = 0;
      if (today) {
        p1FormedAfterPct = pivots.filter(p => p.p1.hour > todayP1Hour).length / pivots.length * 100;
        p1FormedAtOrAfterP2Pct = pivots.filter(p => p.p1.hour >= todayP2Hour).length / pivots.length * 100;
        p2FormedAfterPct = pivots.filter(p => p.p2.hour > todayP2Hour).length / pivots.length * 100;
        p2FormedAfterP2Pct = pivots.filter(p => p.p2.hour > todayP2Hour).length / pivots.length * 100;
      }

      // Flip risk
      const flipRiskPct = today ? pivots.slice(0, -1).filter(p => {
        const dist = (p.p1.price - p.dayOpen) / p.dayOpen * 100;
        const todayDist = (today.p1.price - today.dayOpen) / today.dayOpen * 100;
        return today.p1.type === 'low' ? dist < todayDist : dist > todayDist;
      }).length / Math.max(pivots.length - 1, 1) * 100 : 0;

      // P2 completion
      const p2NewAfterPct = today ? pivots.filter(p => p.p2.hour > todayP2Hour).length / pivots.length * 100 : 0;

      let tableRows = '';
      for (let h = 0; h < 24; h++) {
        const isCurrent = h === currentHour;
        const sessClass = getSessionClass(h);
        const p1Pct = hourlyStats.p1[h];
        const p2Pct = hourlyStats.p2[h];
        const p1Last = hourlyStats.lastP1DaysAgo[h];
        const p2Last = hourlyStats.lastP2DaysAgo[h];
        const p1Bg = schemeColor(p1Pct, maxP1);
        const p2Bg = schemeColor(p2Pct, maxP2);
        const p1Check = h === todayP1Hour ? '<span class="check">✓</span>' : '';
        const p2Check = h === todayP2Hour ? '<span class="check">✓</span>' : '';

        tableRows += `<tr class="${sessClass}${isCurrent ? ' current-hour' : ''}">
          <td class="hour-col">${String(h).padStart(2,'0')}:00</td>
          <td class="heatmap-cell" style="background:${p1Bg};color:${textColor(p1Bg)}">${p1Check}${p1Pct.toFixed(1)}</td>
          <td class="last-col last-cell" data-type="p1" data-hour="${h}">${p1Last !== null ? p1Last + 'd' : '-'}</td>
          <td class="heatmap-cell" style="background:${p2Bg};color:${textColor(p2Bg)}">${p2Check}${p2Pct.toFixed(1)}</td>
          <td class="last-col last-cell" data-type="p2" data-hour="${h}">${p2Last !== null ? p2Last + 'd' : '-'}</td>
        </tr>`;
      }

      const flipLabel = flipRiskPct > 40 ? 'likely' : flipRiskPct > 20 ? 'moderate' : 'unlikely';
      const p2Label = p2NewAfterPct > 50 ? 'unlikely' : p2NewAfterPct > 20 ? 'moderate' : 'likely';

      let html = `<div class="sub-tabs" id="sub-tabs">
        <button class="active" data-sub="daily">Daily</button>
        <button data-sub="weekly">Weekly</button>
        <button data-sub="session">Session</button>
      </div>
      <div class="split-60-40">
        <div class="card" style="padding:0;overflow:hidden">
          <div class="table-scroll" style="max-height:none">
            <table class="prob-table" id="prob-table">
              <thead><tr>
                <th style="padding-left:12px">Hour</th>
                <th style="text-align:right;padding-right:12px">P1 %</th>
                <th style="text-align:right">Last</th>
                <th style="text-align:right;padding-right:12px">P2 %</th>
                <th style="text-align:right;padding-right:12px">Last</th>
              </tr></thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h2 style="font-size:16px;color:#e0e0e0;font-weight:700;margin-bottom:16px">Key Insights</h2>
          <div class="insights-mono">
            <div><strong>${insights.totalDays}</strong> data points used - stats are reliable</div>

            <span class="section-title">Asset: ${document.getElementById('symbol-select').value.toUpperCase()}</span>
            ${today ? `
            <div class="indent">Current P1: Daily ${today.p1.type} (${String(today.p1.hour).padStart(2,'0')}:00)</div>
            <div class="indent">Current P2: Daily ${today.p2.type} (${String(today.p2.hour).padStart(2,'0')}:00)</div>
            ` : ''}

            <span class="section-title">P1 Status</span>
            <div class="indent">${p1FormedAfterPct.toFixed(1)}% of P1's formed after ${String(todayP1Hour).padStart(2,'0')}:00</div>
            <div class="indent">${p1FormedAtOrAfterP2Pct.toFixed(1)}% of P1's formed at or after ${String(todayP2Hour).padStart(2,'0')}:00</div>

            <span class="section-title">P2 Status</span>
            <div class="indent">${p2FormedAfterPct.toFixed(1)}% of P2's formed after ${String(todayP2Hour).padStart(2,'0')}:00</div>
            <div class="indent">${p2FormedAfterP2Pct.toFixed(1)}% of P2's formed after ${String(todayP2Hour).padStart(2,'0')}:00</div>

            <span class="section-title">Summary</span>
            <div class="indent"><span class="${flipLabel === 'likely' ? 'likely' : flipLabel === 'moderate' ? 'moderate' : 'unlikely'}">${flipLabel === 'likely' ? 'Likely' : flipLabel === 'moderate' ? 'Moderate' : 'Low'}</span> P1 flip risk – ${flipRiskPct.toFixed(1)}% of days took out the daily ${today ? today.p1.type : 'low'}</div>
            <div class="indent"><span class="${p2Label === 'unlikely' ? 'unlikely' : p2Label === 'moderate' ? 'moderate' : 'likely'}">${p2Label === 'unlikely' ? 'Unlikely' : p2Label === 'moderate' ? 'Possible' : 'Likely'}</span> P2 is in – ${p2NewAfterPct.toFixed(1)}% of days form a new P2 after ${String(todayP2Hour).padStart(2,'0')}:00</div>

            <span class="section-title">Today's Price Action</span>
            <div id="today-chart"></div>
          </div>
        </div>
      </div>`;

      setContent(html);
      updateFooter();
      bindSubTabs();
      bindLastCells(hourlyStats);
      renderTodayChart();
    }

    // ── Render: TIME > Weekly ──
    function renderTimeWeekly() {
      const wPivots = weeklyPivots;
      if (!wPivots.length) return noData();

      const dayStats = calculateWeeklyDayStats(wPivots);
      const maxP1 = Math.max(...dayStats.p1);
      const maxP2 = Math.max(...dayStats.p2);
      const currentDay = new Date().getUTCDay();

      let tableRows = '';
      for (let d = 1; d <= 7; d++) {
        const dow = d % 7; // Mon=1..Sun=0
        const isCurrent = dow === currentDay;
        const p1Pct = dayStats.p1[dow];
        const p2Pct = dayStats.p2[dow];
        const p1Last = dayStats.lastP1DaysAgo[dow];
        const p2Last = dayStats.lastP2DaysAgo[dow];
        const p1Width = maxP1 > 0 ? (p1Pct / maxP1 * 80) : 0;
        const p2Width = maxP2 > 0 ? (p2Pct / maxP2 * 80) : 0;

        tableRows += `<tr class="${isCurrent ? 'current-hour' : ''}">
          <td style="color:#aaa">${DAY_NAMES_FULL[dow]}</td>
          <td><span class="pct-bar" style="width:${p1Width}px;background:${schemeColor(p1Pct, maxP1)}"></span>${p1Pct.toFixed(1)}%</td>
          <td class="last-cell" data-type="wp1" data-dow="${dow}">${p1Last !== null ? p1Last + 'd' : '—'}</td>
          <td><span class="pct-bar" style="width:${p2Width}px;background:${schemeColor(p2Pct, maxP2)}"></span>${p2Pct.toFixed(1)}%</td>
          <td class="last-cell" data-type="wp2" data-dow="${dow}">${p2Last !== null ? p2Last + 'd' : '—'}</td>
        </tr>`;
      }

      const insights = generateInsights(filteredPivots);

      let html = `<div class="sub-tabs" id="sub-tabs">
        <button data-sub="daily">Daily</button>
        <button class="active" data-sub="weekly">Weekly</button>
      </div>
      <div class="split-60-40">
        <div class="card">
          <h2>Weekly P1/P2 Day Probability</h2>
          <table class="prob-table">
            <thead><tr><th>Day</th><th>P1%</th><th>Last</th><th>P2%</th><th>Last</th></tr></thead>
            <tbody>${tableRows}</tbody>
          </table>
        </div>
        <div class="card">
          <h2>Weekly Insights</h2>
          <div class="insight-section">
            <h3>Overview</h3>
            <div class="insight-row"><span class="insight-label">Weeks Analyzed</span><span class="insight-val">${wPivots.length}</span></div>
            <div class="insight-row"><span class="insight-label">High-first weeks</span><span class="insight-val">${(wPivots.filter(w => w.p1.type === 'high').length / wPivots.length * 100).toFixed(0)}%</span></div>
            <div class="insight-row"><span class="insight-label">Avg Weekly Range</span><span class="insight-val">${(wPivots.reduce((s,w) => s + w.range, 0) / wPivots.length).toFixed(2)}%</span></div>
          </div>
          <div class="insight-section">
            <h3>Distances</h3>
            <div class="insight-row"><span class="insight-label">Avg Open→P1</span><span class="insight-val">${distanceStats(wPivots.map(w=>w.openToP1)).mean.toFixed(2)}%</span></div>
            <div class="insight-row"><span class="insight-label">Avg P1→P2</span><span class="insight-val">${distanceStats(wPivots.map(w=>w.p1ToP2)).mean.toFixed(2)}%</span></div>
          </div>
        </div>
      </div>`;

      setContent(html);
      bindSubTabs();

      // Bind last cells for weekly
      const dayStatsRef = dayStats;
      document.querySelectorAll('.last-cell').forEach(cell => {
        cell.addEventListener('click', (e) => {
          const type = cell.dataset.type;
          const dow = parseInt(cell.dataset.dow);
          if (type === 'wp1') showPopover(e, dayStatsRef.p1LastDates[dow], `P1 on ${DAYS[dow]}`);
          else showPopover(e, dayStatsRef.p2LastDates[dow], `P2 on ${DAYS[dow]}`);
        });
      });
    }

    // ── Render: DISTANCE > Daily ──
    function renderDistanceDaily() {
      const pivots = filteredPivots;
      if (!pivots.length) return noData();

      const openToP1Vals = pivots.map(p => p.openToP1Signed);
      const p1ToP2Vals = pivots.map(p => p.p1ToP2Signed);
      const openToP1Stats_d = distanceStats(openToP1Vals);
      const p1ToP2Stats_d = distanceStats(p1ToP2Vals);
      const openToP1Hist = buildHistogram(openToP1Vals);
      const p1ToP2Hist = buildHistogram(p1ToP2Vals);

      const insights = generateInsights(pivots);
      const flipColor = insights.flipRiskPct > 40 ? 'red' : insights.flipRiskPct > 20 ? 'yellow' : 'green';
      const p2Color = insights.p2CompletionPct > 50 ? 'red' : insights.p2CompletionPct > 20 ? 'yellow' : 'green';
      const indClass = c => c === 'red' ? 'ind-red' : c === 'yellow' ? 'ind-yellow' : 'ind-green';

      function renderHistBars(hist, color, idPrefix) {
        const maxCount = Math.max(...hist.bins, 1);
        return hist.bins.map((count, i) => {
          const h = count / maxCount * 100;
          const rangeStart = (hist.min + i * hist.step).toFixed(2);
          const rangeEnd = (hist.min + (i + 1) * hist.step).toFixed(2);
          const isNeg = hist.min + (i + 0.5) * hist.step < 0;
          const barColor = isNeg ? '#FF4C61' : '#32D695';
          return `<div class="hist-bar" id="${idPrefix}-${i}" style="height:${h}%;background:${barColor}" title="${rangeStart}% to ${rangeEnd}% — ${count} days" data-idx="${i}"></div>`;
        }).join('');
      }

      // Zero line position for signed histograms
      function zeroLinePos(hist) {
        if (hist.min >= 0 || hist.max <= 0) return null;
        return ((0 - hist.min) / (hist.max - hist.min) * 100);
      }

      const zeroP1 = zeroLinePos(openToP1Hist);
      const zeroP2 = zeroLinePos(p1ToP2Hist);

      let html = `<div class="sub-tabs" id="sub-tabs">
        <button class="active" data-sub="daily">Daily</button>
        <button data-sub="weekly">Weekly</button>
      </div>
      <div class="split-65-35">
        <div>
          <div class="card histogram-container">
            <h2>Open → P1 Distance (Signed)</h2>
            <div class="histogram-wrapper">
              <div class="histogram" id="hist-op1">${renderHistBars(openToP1Hist, '#32D695', 'op1')}</div>
              ${zeroP1 !== null ? `<div style="position:absolute;bottom:0;left:${zeroP1}%;width:1px;height:120px;border-left:1px dashed #555;pointer-events:none"></div>` : ''}
            </div>
            <div class="hist-labels"><span>${openToP1Hist.min.toFixed(2)}%</span><span>0%</span><span>${openToP1Hist.max.toFixed(2)}%</span></div>
            <div class="hist-stats">
              <span>Mean: <strong>${openToP1Stats_d.mean.toFixed(2)}%</strong></span>
              <span>Median: <strong>${openToP1Stats_d.median.toFixed(2)}%</strong></span>
              <span>σ: <strong>${openToP1Stats_d.stdev.toFixed(2)}%</strong></span>
            </div>
          </div>
          <div class="card histogram-container">
            <h2>P1 → P2 Distance (Signed)</h2>
            <div class="histogram-wrapper">
              <div class="histogram" id="hist-p1p2">${renderHistBars(p1ToP2Hist, '#E6A817', 'p1p2')}</div>
              ${zeroP2 !== null ? `<div style="position:absolute;bottom:0;left:${zeroP2}%;width:1px;height:120px;border-left:1px dashed #555;pointer-events:none"></div>` : ''}
            </div>
            <div class="hist-labels"><span>${p1ToP2Hist.min.toFixed(2)}%</span><span>0%</span><span>${p1ToP2Hist.max.toFixed(2)}%</span></div>
            <div class="hist-stats">
              <span>Mean: <strong>${p1ToP2Stats_d.mean.toFixed(2)}%</strong></span>
              <span>Median: <strong>${p1ToP2Stats_d.median.toFixed(2)}%</strong></span>
              <span>σ: <strong>${p1ToP2Stats_d.stdev.toFixed(2)}%</strong></span>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Distance Insights</h2>
          <div class="insight-section">
            <h3>Flip Risk</h3>
            <div class="insight-row" style="border-left-color:${flipColor === 'red' ? '#FF4C61' : flipColor === 'yellow' ? '#E6A817' : '#32D695'}">
              <span class="insight-label">P1 exceeded</span>
              <span class="insight-val">${insights.flipRiskPct.toFixed(0)}% <span class="indicator ${indClass(flipColor)}"></span></span>
            </div>
            <div style="font-size:11px;color:#666;padding:4px 10px;margin-bottom:8px">
              ${flipColor === 'red' ? 'High flip risk — P1 level frequently exceeded' : flipColor === 'yellow' ? 'Moderate — monitor for reversal' : 'Low flip risk — P1 likely holds'}
            </div>
          </div>
          <div class="insight-section">
            <h3>P2 Completion</h3>
            <div class="insight-row" style="border-left-color:${p2Color === 'red' ? '#FF4C61' : p2Color === 'yellow' ? '#E6A817' : '#32D695'}">
              <span class="insight-label">More displacement expected</span>
              <span class="insight-val">${insights.p2CompletionPct.toFixed(0)}% <span class="indicator ${indClass(p2Color)}"></span></span>
            </div>
            <div style="font-size:11px;color:#666;padding:4px 10px;margin-bottom:8px">
              ${p2Color === 'red' ? 'P2 likely not done — most days moved further' : p2Color === 'yellow' ? 'Some room for more P2 extension' : 'P2 likely complete'}
            </div>
          </div>
          <div class="insight-section">
            <h3>P1 Metrics</h3>
            <div class="insight-row"><span class="insight-label">P1 formed by now</span><span class="insight-val">${insights.p1BeforeNow.toFixed(0)}%</span></div>
            <div class="insight-row"><span class="insight-label">Avg Open→P1</span><span class="insight-val">${insights.openToP1Stats.mean.toFixed(2)}%</span></div>
            <div class="insight-row"><span class="insight-label">Avg P1→P2</span><span class="insight-val">${insights.p1ToP2Stats.mean.toFixed(2)}%</span></div>
          </div>
        </div>
      </div>`;

      setContent(html);
      bindSubTabs();

      // Bind histogram bar clicks
      document.querySelectorAll('#hist-op1 .hist-bar').forEach(bar => {
        bar.addEventListener('click', () => {
          const idx = parseInt(bar.dataset.idx);
          const matchingPivots = openToP1Hist.indices[idx].map(i => pivots[i]);
          const rangeStart = (openToP1Hist.min + idx * openToP1Hist.step).toFixed(2);
          const rangeEnd = (openToP1Hist.min + (idx + 1) * openToP1Hist.step).toFixed(2);
          showModal(`Open→P1: ${rangeStart}% to ${rangeEnd}%`, matchingPivots);
        });
      });

      document.querySelectorAll('#hist-p1p2 .hist-bar').forEach(bar => {
        bar.addEventListener('click', () => {
          const idx = parseInt(bar.dataset.idx);
          const matchingPivots = p1ToP2Hist.indices[idx].map(i => pivots[i]);
          const rangeStart = (p1ToP2Hist.min + idx * p1ToP2Hist.step).toFixed(2);
          const rangeEnd = (p1ToP2Hist.min + (idx + 1) * p1ToP2Hist.step).toFixed(2);
          showModal(`P1→P2: ${rangeStart}% to ${rangeEnd}%`, matchingPivots);
        });
      });

      // Bind insight row clicks to highlight histogram bars
      document.querySelectorAll('.insight-row').forEach(row => {
        row.addEventListener('click', () => {
          // Toggle highlighting
          const label = row.querySelector('.insight-label')?.textContent;
          if (!label) return;

          const allBars = document.querySelectorAll('.hist-bar');
          const isHighlighted = row.classList.contains('highlighted-insight');

          // Reset all
          allBars.forEach(b => { b.classList.remove('highlighted', 'dimmed'); });
          document.querySelectorAll('.insight-row').forEach(r => r.classList.remove('highlighted-insight'));

          if (!isHighlighted && label.includes('Open→P1')) {
            row.classList.add('highlighted-insight');
            document.querySelectorAll('#hist-op1 .hist-bar').forEach(b => b.classList.add('highlighted'));
            document.querySelectorAll('#hist-p1p2 .hist-bar').forEach(b => b.classList.add('dimmed'));
          } else if (!isHighlighted && label.includes('P1→P2')) {
            row.classList.add('highlighted-insight');
            document.querySelectorAll('#hist-p1p2 .hist-bar').forEach(b => b.classList.add('highlighted'));
            document.querySelectorAll('#hist-op1 .hist-bar').forEach(b => b.classList.add('dimmed'));
          }
        });
      });
    }

    // ── Render: DISTANCE > Weekly ──
    function renderDistanceWeekly() {
      const wPivots = weeklyPivots;
      if (!wPivots.length) return noData();

      const openToP1Vals = wPivots.map(w => w.openToP1);
      const p1ToP2Vals = wPivots.map(w => w.p1ToP2);
      const op1Stats = distanceStats(openToP1Vals);
      const p1p2Stats = distanceStats(p1ToP2Vals);
      const op1Hist = buildHistogram(openToP1Vals);
      const p1p2Hist = buildHistogram(p1ToP2Vals);

      function renderBars(hist, color, id) {
        const mx = Math.max(...hist.bins, 1);
        return hist.bins.map((c, i) => `<div class="hist-bar" style="height:${c/mx*100}%;background:${color}" title="${(hist.min+i*hist.step).toFixed(2)}%–${(hist.min+(i+1)*hist.step).toFixed(2)}% — ${c} weeks" data-idx="${i}"></div>`).join('');
      }

      let html = `<div class="sub-tabs" id="sub-tabs">
        <button data-sub="daily">Daily</button>
        <button class="active" data-sub="weekly">Weekly</button>
      </div>
      <div class="split-65-35">
        <div>
          <div class="card histogram-container">
            <h2>Weekly Open → P1 Distance</h2>
            <div class="histogram">${renderBars(op1Hist, '#32D695', 'wop1')}</div>
            <div class="hist-labels"><span>${op1Hist.min.toFixed(2)}%</span><span>${op1Hist.max.toFixed(2)}%</span></div>
            <div class="hist-stats">
              <span>Mean: <strong>${op1Stats.mean.toFixed(2)}%</strong></span>
              <span>Median: <strong>${op1Stats.median.toFixed(2)}%</strong></span>
              <span>σ: <strong>${op1Stats.stdev.toFixed(2)}%</strong></span>
            </div>
          </div>
          <div class="card histogram-container">
            <h2>Weekly P1 → P2 Distance</h2>
            <div class="histogram">${renderBars(p1p2Hist, '#E6A817', 'wp1p2')}</div>
            <div class="hist-labels"><span>${p1p2Hist.min.toFixed(2)}%</span><span>${p1p2Hist.max.toFixed(2)}%</span></div>
            <div class="hist-stats">
              <span>Mean: <strong>${p1p2Stats.mean.toFixed(2)}%</strong></span>
              <span>Median: <strong>${p1p2Stats.median.toFixed(2)}%</strong></span>
              <span>σ: <strong>${p1p2Stats.stdev.toFixed(2)}%</strong></span>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Weekly Distance Insights</h2>
          <div class="insight-section">
            <h3>Overview</h3>
            <div class="insight-row"><span class="insight-label">Weeks</span><span class="insight-val">${wPivots.length}</span></div>
            <div class="insight-row"><span class="insight-label">Avg Open→P1</span><span class="insight-val">${op1Stats.mean.toFixed(2)}%</span></div>
            <div class="insight-row"><span class="insight-label">Avg P1→P2</span><span class="insight-val">${p1p2Stats.mean.toFixed(2)}%</span></div>
            <div class="insight-row"><span class="insight-label">Avg Range</span><span class="insight-val">${(wPivots.reduce((s,w)=>s+w.range,0)/wPivots.length).toFixed(2)}%</span></div>
          </div>
        </div>
      </div>`;

      setContent(html);
      bindSubTabs();
    }

    // ── Render: SUMMARY ──
    function renderSummary() {
      const pivots = filteredPivots;
      if (!pivots.length) return noData();

      const insights = generateInsights(pivots);
      const hourlyStats = calculateHourlyStats(pivots);
      const peakP1Hour = hourlyStats.p1.indexOf(Math.max(...hourlyStats.p1));
      const peakP2Hour = hourlyStats.p2.indexOf(Math.max(...hourlyStats.p2));
      const highFirstCount = pivots.filter(p => p.p1.type === 'high').length;

      const flipColor = insights.flipRiskPct > 40 ? 'red' : insights.flipRiskPct > 20 ? 'yellow' : 'green';
      const p2Color = insights.p2CompletionPct > 50 ? 'red' : insights.p2CompletionPct > 20 ? 'yellow' : 'green';
      const indClass = c => c === 'red' ? 'ind-red' : c === 'yellow' ? 'ind-yellow' : 'ind-green';

      const today = insights.today;

      let html = `<div class="card">
        <h2>Summary — ${document.getElementById('symbol-select').value.toUpperCase()} on ${document.getElementById('exchange-select').value}</h2>
        <div class="summary-grid">
          <div class="stat-box">
            <div class="stat-label">Days Analyzed</div>
            <div class="stat-value">${pivots.length}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Weeks Analyzed</div>
            <div class="stat-value">${weeklyPivots.length}</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">High-First Bias</div>
            <div class="stat-value" style="color:#FF4C61">${insights.highFirstPct.toFixed(0)}%</div>
            <div class="stat-sub">${highFirstCount}/${pivots.length} days</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Peak P1 Hour</div>
            <div class="stat-value" style="color:#E6A817">${peakP1Hour}:00</div>
            <div class="stat-sub">${getSession(peakP1Hour)} — ${hourlyStats.p1[peakP1Hour].toFixed(0)}%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Peak P2 Hour</div>
            <div class="stat-value" style="color:#E6A817">${peakP2Hour}:00</div>
            <div class="stat-sub">${getSession(peakP2Hour)} — ${hourlyStats.p2[peakP2Hour].toFixed(0)}%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg Range</div>
            <div class="stat-value">${insights.avgRange.toFixed(2)}%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg Open→P1</div>
            <div class="stat-value" style="color:#32D695">${insights.openToP1Stats.mean.toFixed(2)}%</div>
            <div class="stat-sub">σ ${insights.openToP1Stats.stdev.toFixed(2)}%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg P1→P2</div>
            <div class="stat-value" style="color:#E6A817">${insights.p1ToP2Stats.mean.toFixed(2)}%</div>
            <div class="stat-sub">σ ${insights.p1ToP2Stats.stdev.toFixed(2)}%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Flip Risk</div>
            <div class="stat-value">${insights.flipRiskPct.toFixed(0)}% <span class="indicator ${indClass(flipColor)}"></span></div>
          </div>
          <div class="stat-box">
            <div class="stat-label">P2 Status</div>
            <div class="stat-value">${insights.p2CompletionPct.toFixed(0)}% <span class="indicator ${indClass(p2Color)}"></span></div>
          </div>
        </div>
      </div>`;

      // Current day
      if (today) {
        html += `<div class="card">
          <h2>Latest Day — ${today.date}</h2>
          <div class="summary-grid">
            <div class="stat-box">
              <div class="stat-label">P1 (${today.p1.type})</div>
              <div class="stat-value ${today.p1.type === 'high' ? 'p1-high' : 'p1-low'}">${today.p1.price.toFixed(2)}</div>
              <div class="stat-sub">${today.p1.hour}:00 UTC · ${getSession(today.p1.hour)}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">P2 (${today.p2.type})</div>
              <div class="stat-value ${today.p2.type === 'high' ? 'p1-high' : 'p1-low'}">${today.p2.price.toFixed(2)}</div>
              <div class="stat-sub">${today.p2.hour}:00 UTC · ${getSession(today.p2.hour)}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Open→P1</div>
              <div class="stat-value" style="color:#E6A817">${today.openToP1.toFixed(2)}%</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">P1→P2</div>
              <div class="stat-value" style="color:#E6A817">${today.p1ToP2.toFixed(2)}%</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Range</div>
              <div class="stat-value">${today.range.toFixed(2)}%</div>
            </div>
          </div>
        </div>`;
      }

      // Daily pivot log
      html += `<div class="card">
        <h2>Daily Pivot Log (${pivots.length} days)</h2>
        <div class="table-scroll">
          <table class="prob-table">
            <thead><tr>
              <th>Date</th><th>Day</th><th>Open</th>
              <th>P1</th><th>P1 Hr</th><th>Type</th>
              <th>P2</th><th>P2 Hr</th>
              <th>O→P1</th><th>P1→P2</th><th>Range</th>
            </tr></thead>
            <tbody>
              ${[...pivots].reverse().map(p => `<tr>
                <td style="color:#aaa">${p.date}</td>
                <td style="color:#666">${DAYS[p.dayOfWeek]}</td>
                <td>${p.dayOpen.toFixed(2)}</td>
                <td class="${p.p1.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p1.price.toFixed(2)}</td>
                <td>${p.p1.hour}:00</td>
                <td class="${p.p1.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p1.type.toUpperCase()}</td>
                <td class="${p.p2.type === 'high' ? 'p1-high' : 'p1-low'}">${p.p2.price.toFixed(2)}</td>
                <td>${p.p2.hour}:00</td>
                <td style="color:#E6A817">${p.openToP1.toFixed(2)}%</td>
                <td style="color:#E6A817">${p.p1ToP2.toFixed(2)}%</td>
                <td>${p.range.toFixed(2)}%</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`;

      setContent(html);
    }

    // ── Helpers ──
    function noData() {
      document.getElementById('content').innerHTML = '<div style="text-align:center;padding:40px;color:#666;">No data for selected filters.</div>';
    }

    function setContent(html) {
      document.getElementById('content').innerHTML = html;
    }

    function bindSubTabs() {
      const subTabs = document.getElementById('sub-tabs');
      if (!subTabs) return;
      subTabs.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        activeSubTab = e.target.dataset.sub;
        renderActive();
      });
    }

    function bindLastCells(hourlyStats) {
      document.querySelectorAll('.last-cell').forEach(cell => {
        cell.addEventListener('click', (e) => {
          const type = cell.dataset.type;
          const hour = parseInt(cell.dataset.hour);
          if (type === 'p1') showPopover(e, hourlyStats.p1LastDates[hour], `P1 at ${hour}:00`);
          else if (type === 'p2') showPopover(e, hourlyStats.p2LastDates[hour], `P2 at ${hour}:00`);
        });
      });
    }

    // ── Today's Price Action Chart ──
    function renderTodayChart() {
      const container = document.getElementById('today-chart');
      if (!container || typeof LightweightCharts === 'undefined') return;

      // Get today's candles
      const todayStr = new Date().toISOString().slice(0, 10);
      const todayCandles = hourlyCandles.filter(c => {
        return new Date(c.timestamp).toISOString().slice(0, 10) === todayStr;
      }).sort((a, b) => a.timestamp - b.timestamp);

      if (!todayCandles.length) return;

      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 180,
        layout: {
          background: { type: 'solid', color: '#1e1e1e' },
          textColor: '#666',
          fontFamily: 'SF Mono, Fira Code, monospace',
          fontSize: 10,
        },
        grid: { vertLines: { color: '#2a2a2a' }, horzLines: { color: '#2a2a2a' } },
        rightPriceScale: { borderColor: '#2a2a2a' },
        timeScale: { borderColor: '#2a2a2a', timeVisible: true, secondsVisible: false },
        crosshair: { mode: 0 },
      });

      const lineSeries = chart.addLineSeries({
        color: '#32D695',
        lineWidth: 2,
        priceLineVisible: false,
        lastValueVisible: false,
      });

      lineSeries.setData(todayCandles.map(c => ({
        time: Math.floor(c.timestamp / 1000),
        value: c.close,
      })));

      chart.timeScale().fitContent();
    }

    function updateFooter() {
      const fd = document.getElementById('footer-days');
      const fs = document.getElementById('footer-scheme');
      if (fd) fd.textContent = filteredPivots.length;
      if (fs) fs.textContent = colorScheme.charAt(0).toUpperCase() + colorScheme.slice(1);
    }

    function renderActive() {
      closePopover();
      if (activeTab === 'time') {
        if (activeSubTab === 'weekly') renderTimeWeekly();
        else renderTimeDaily();
      } else if (activeTab === 'distance') {
        if (activeSubTab === 'weekly') renderDistanceWeekly();
        else renderDistanceDaily();
      } else {
        renderSummary();
      }
    }

    // ── Load ──
    async function loadData() {
      const content = document.getElementById('content');
      content.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">Loading pivot data...</div>';

      const exchange = document.getElementById('exchange-select').value;
      const symbol = document.getElementById('symbol-select').value;
      const days = parseInt(document.getElementById('days-select').value);

      try {
        hourlyCandles = await fetchCandles(exchange, symbol, days);
        allPivots = calculateDailyPivots(hourlyCandles);
        weeklyPivots = calculateWeeklyPivots(allPivots);
        applyFilter();
      } catch (err) {
        content.innerHTML = `<div style="text-align:center;padding:40px;color:#FF4C61;">Error: ${err.message}</div>`;
        console.error(err);
      }
    }

    function applyFilter() {
      if (weekdayFilter === 'all') {
        filteredPivots = allPivots;
      } else {
        const day = parseInt(weekdayFilter);
        filteredPivots = allPivots.filter(p => p.dayOfWeek === day);
      }
      weeklyPivots = calculateWeeklyPivots(filteredPivots);
      renderActive();
    }

    // ── Events ──
    document.getElementById('symbol-select').addEventListener('change', loadData);
    document.getElementById('exchange-select').addEventListener('change', loadData);
    document.getElementById('days-select').addEventListener('change', loadData);
    document.getElementById('scheme-select').addEventListener('change', (e) => {
      colorScheme = e.target.value;
      renderActive();
      updateFooter();
    });

    document.getElementById('weekday-filter').addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      document.querySelectorAll('#weekday-filter button').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      weekdayFilter = e.target.dataset.day;
      applyFilter();
    });

    document.getElementById('main-tabs').addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      document.querySelectorAll('#main-tabs button').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      activeTab = e.target.dataset.tab;
      activeSubTab = 'daily'; // reset sub-tab
      renderActive();
    });

    // ── Current hour highlighting refresh ──
    setInterval(() => {
      const row = document.querySelector('.current-hour');
      if (row) {
        const currentHour = new Date().getUTCHours();
        const hourCell = row.querySelector('td');
        if (hourCell && !hourCell.textContent.startsWith(String(currentHour).padStart(2, '0'))) {
          renderActive();
        }
      }
    }, 60000);

    // ── Init ──
    loadData();
  </script>
</body>
</html>
