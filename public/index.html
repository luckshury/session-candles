<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Session Candles</title>
  <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
  <link rel="stylesheet" href="/shared.css">
</head>
<body>
  <nav class="nav">
    <span class="logo">MMT Tools</span>
    <a href="/" class="active">Session Candles</a>
    <a href="/pivot.html">Pivot Analysis</a>
  </nav>

  <div class="toolbar">
    <span class="label">Symbol</span>
    <select id="symbol-select">
      <option value="btc/usd">BTC/USD</option>
      <option value="eth/usd">ETH/USD</option>
      <option value="sol/usd">SOL/USD</option>
    </select>

    <span class="label">Exchange</span>
    <select id="exchange-select">
      <optgroup label="Futures (Linear)">
        <option value="binancef">Binance Futures</option>
        <option value="bybitf">Bybit Futures</option>
        <option value="okxf">OKX Futures</option>
        <option value="deribitf">Deribit Futures</option>
        <option value="hyperliquid">Hyperliquid</option>
        <option value="hyperliquid-xyz">Hyperliquid XYZ</option>
        <option value="bitmexf">BitMEX Futures</option>
        <option value="bitfinexf">Bitfinex Futures</option>
        <option value="lighterf">Lighter</option>
      </optgroup>
      <optgroup label="Futures (Inverse)">
        <option value="bybitf-inverse">Bybit Inverse</option>
        <option value="bitmexf-inverse">BitMEX Inverse</option>
        <option value="deribitf-inverse">Deribit Inverse</option>
      </optgroup>
      <optgroup label="Spot">
        <option value="binance">Binance Spot</option>
        <option value="bybit">Bybit Spot</option>
        <option value="coinbase">Coinbase</option>
        <option value="okx">OKX Spot</option>
        <option value="deribit">Deribit Spot</option>
        <option value="kraken">Kraken</option>
        <option value="bitfinex">Bitfinex</option>
      </optgroup>
    </select>

    <span class="label">Days</span>
    <select id="days-select">
      <option value="7">7</option>
      <option value="14">14</option>
      <option value="30" selected>30</option>
      <option value="90">90</option>
      <option value="180">180</option>
    </select>
  </div>

  <div id="chart-container">
    <div class="loading" id="loading">Loading session candles...</div>
  </div>

  <script>
    const SESSIONS = [
      { name: 'Asia',     startHour: 0,  endHour: 6  },
      { name: 'London',   startHour: 6,  endHour: 12 },
      { name: 'New York', startHour: 12, endHour: 20 },
      { name: 'Close',    startHour: 20, endHour: 24 },
    ];

    const UP_COLOR = '#32D695';
    const DOWN_COLOR = '#FF4C61';
    const BG_COLOR = '#161616';

    let chart, candleSeries;

    function initChart() {
      const container = document.getElementById('chart-container');
      chart = LightweightCharts.createChart(container, {
        layout: {
          background: { type: 'solid', color: BG_COLOR },
          textColor: '#888',
          fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif',
        },
        grid: { vertLines: { color: '#1e1e1e' }, horzLines: { color: '#1e1e1e' } },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
          vertLine: { color: '#444', width: 1, style: 2 },
          horzLine: { color: '#444', width: 1, style: 2 },
        },
        rightPriceScale: { borderColor: '#2a2a2a', scaleMargins: { top: 0.1, bottom: 0.1 } },
        timeScale: { borderColor: '#2a2a2a', timeVisible: true, secondsVisible: false },
        handleScroll: true,
        handleScale: true,
      });

      candleSeries = chart.addCandlestickSeries({
        upColor: UP_COLOR, downColor: DOWN_COLOR,
        borderUpColor: UP_COLOR, borderDownColor: DOWN_COLOR,
        wickUpColor: UP_COLOR, wickDownColor: DOWN_COLOR,
      });

      const ro = new ResizeObserver(() => {
        chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
      });
      ro.observe(container);
    }

    function aggregateToSessions(candles) {
      candles.sort((a, b) => a.t - b.t);
      const sessionCandles = [];
      let current = null;

      for (const c of candles) {
        const date = new Date(c.t * 1000);
        const hour = date.getUTCHours();
        const session = SESSIONS.find(s => hour >= s.startHour && hour < s.endHour);
        if (!session) continue;

        const dayStr = date.toISOString().slice(0, 10);
        const key = `${dayStr}-${session.name}`;

        if (!current || current._key !== key) {
          if (current) sessionCandles.push(current);
          current = {
            _key: key, time: c.t,
            open: c.o, high: c.h, low: c.l, close: c.c,
            _volume: (c.vb || 0) + (c.vs || 0),
          };
        } else {
          current.high = Math.max(current.high, c.h);
          current.low = Math.min(current.low, c.l);
          current.close = c.c;
          current._volume += (c.vb || 0) + (c.vs || 0);
        }
      }
      if (current) sessionCandles.push(current);
      return sessionCandles;
    }

    function colorize(sessionCandles) {
      return sessionCandles.map(sc => {
        const color = sc.close >= sc.open ? UP_COLOR : DOWN_COLOR;
        return { time: sc.time, open: sc.open, high: sc.high, low: sc.low, close: sc.close, color, borderColor: color, wickColor: color };
      });
    }

    async function fetchCandles(exchange, symbol, days) {
      const now = Math.floor(Date.now() / 1000);
      const from = now - days * 86400;
      const url = `/api/candles?exchange=${exchange}&symbol=${encodeURIComponent(symbol)}&tf=1h&from=${from}&to=${now}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if (json.error) throw new Error(json.error);
      return json.data || [];
    }

    async function loadChart() {
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      const exchange = document.getElementById('exchange-select').value;
      const symbol = document.getElementById('symbol-select').value;
      const days = parseInt(document.getElementById('days-select').value);

      try {
        const raw = await fetchCandles(exchange, symbol, days);
        const sessions = aggregateToSessions(raw);
        const colored = colorize(sessions);
        candleSeries.setData(colored);
        chart.timeScale().fitContent();
        loading.style.display = 'none';
      } catch (err) {
        loading.textContent = 'Error: ' + err.message;
        console.error(err);
      }
    }

    initChart();
    loadChart();
    document.getElementById('symbol-select').addEventListener('change', loadChart);
    document.getElementById('exchange-select').addEventListener('change', loadChart);
    document.getElementById('days-select').addEventListener('change', loadChart);
  </script>
</body>
</html>
